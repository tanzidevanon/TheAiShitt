name: Windows RDP via Cloudflare

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        net user runneradmin TempP@ss123

    - name: Download cloudflared
      run: |
        curl -L -o cloudflared.exe https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe

    - name: Start Cloudflare Tunnel (RDP)
      env:
        TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        start /B cloudflared.exe tunnel run --token %TUNNEL_TOKEN%

    - name: Keep alive
      run: |
        echo "RDP Ready. Do not close."
        ping -t 127.0.0.1 > nul
