name: Windows RDP via Cloudflare

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Enable RDP
      shell: cmd
      run: |
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        net user runneradmin TempP@ss123

    - name: Download cloudflared
      shell: cmd
      run: |
        :: EXE ফাইলটি সরাসরি ডাউনলোড করা হচ্ছে
        curl -L -o cloudflared.exe https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe
        :: চেক করা হচ্ছে ফাইলটি ডাউনলোড হয়েছে কি না
        dir cloudflared.exe

    - name: Start Cloudflare Tunnel (RDP)
      shell: cmd
      env:
        TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      run: |
        :: টানেল স্টার্ট করা এবং আউটপুট লগ ফাইলে সেভ করা
        start /B cloudflared.exe tunnel run --token %TUNNEL_TOKEN% > tunnel_log.txt 2>&1
        
        :: ১০ সেকেন্ড অপেক্ষা করা যাতে টানেলটি স্টার্ট হওয়ার সময় পায়
        timeout /t 10 /nobreak > nul
        
        :: লগের প্রথম কয়েক লাইন প্রিন্ট করা সমস্যা বোঝার জন্য
        type tunnel_log.txt

    - name: Keep alive
      shell: cmd
      run: |
        echo "==============================================="
        echo "RDP Ready! Connect via rdp.ontoit.dpdns.org"
        echo "Check Cloudflare Dashboard, Status should be HEALTHY"
        echo "==============================================="
        ping -t 127.0.0.1 > nul
