name: cloudflare-proxy-debug-v4

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y dante-server curl net-tools

      - name: Configure Dante
        run: |
          sudo tee /etc/danted.conf > /dev/null <<'EOF'
          logoutput: stderr
          internal: 0.0.0.0 port = 1080
          external: eth0
          socksmethod: none
          user.privileged: root
          user.unprivileged: nobody
          
          client pass { from: 0.0.0.0/0 to: 0.0.0.0/0 }
          socks pass { from: 0.0.0.0/0 to: 0.0.0.0/0 protocol: tcp udp }
          EOF

      - name: Start Dante Proxy
        run: |
          sudo systemctl restart danted
          sleep 5
          sudo systemctl status danted --no-pager

      - name: âœ… Test Proxy Internally
        run: |
          echo "Testing if proxy is working inside the runner..."
          # à¦à¦‡ à¦•à¦®à¦¾à¦¨à§à¦¡à¦Ÿà¦¿ à¦ªà§à¦°à¦•à§à¦¸à¦¿ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦¨à¦¿à¦œà§‡à¦° à¦†à¦‡à¦ªà¦¿ à¦šà§‡à¦• à¦•à¦°à¦¾à¦° à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦•à¦°à¦¬à§‡
          if curl -v -x socks5h://127.0.0.1:1080 http://ifconfig.me; then
            echo "INTERNAL_PROXY_WORKING=true" >> $GITHUB_ENV
          else
            echo "INTERNAL_PROXY_WORKING=false" >> $GITHUB_ENV
            echo "Error: Dante proxy is not responding inside the runner."
            exit 1
          fi

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Run Cloudflare Tunnel
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # à¦°à¦¾à¦¨à¦¾à¦°à§‡à¦° à¦­à§‡à¦¤à¦° à¦Ÿà¦¾à¦¨à§‡à¦² à¦¶à§à¦°à§ à¦•à¦°à¦¾
          cloudflared tunnel run --token $CF_TOKEN &
          sleep 10

      - name: Show Summary
        run: |
          echo "# ðŸ›  Proxy Debug Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Internal Proxy Test | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Domain | \`ip.ontoit.dpdns.org\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Local Port | \`1080\` |" >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: sleep 3600
