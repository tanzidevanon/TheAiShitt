name: cloudflare-proxy-final-v3

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dante Server
        run: |
          sudo apt update
          sudo apt install -y dante-server

      - name: Configure Dante (Ultra-Compatible)
        run: |
          sudo tee /etc/danted.conf > /dev/null <<'EOF'
          logoutput: stderr
          # Listen on all interfaces so cloudflared can reach it
          internal: 0.0.0.0 port = 1080
          external: eth0
          socksmethod: none
          user.privileged: root
          user.unprivileged: nobody
          
          client pass {
              from: 0.0.0.0/0 to: 0.0.0.0/0
              log: error
          }
          
          socks pass {
              from: 0.0.0.0/0 to: 0.0.0.0/0
              protocol: tcp udp
              log: error
          }
          EOF

      - name: Start Dante Proxy
        run: |
          sudo systemctl restart danted
          sleep 2
          sudo systemctl status danted --no-pager
          # Test if port 1080 is actually listening
          netstat -tuln | grep 1080

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Run Cloudflare Tunnel
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # Use 127.0.0.1 to ensure local routing within the runner
          cloudflared tunnel run --token $CF_TOKEN &
          sleep 10

      - name: Show Summary
        run: |
          echo "# ðŸš€ Proxy Ready" >> $GITHUB_STEP_SUMMARY
          echo "Hostname: \`ip.ontoit.dpdns.org\`" >> $GITHUB_STEP_SUMMARY
          echo "Local Port: \`1080\`" >> $GITHUB_STEP_SUMMARY
          echo "Auth: \`None (For Testing)\`" >> $GITHUB_STEP_SUMMARY

      - name: Keep Alive
        run: sleep 3600
