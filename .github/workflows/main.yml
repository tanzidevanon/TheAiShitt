name: temp-proxy-cloudflare-pretty

on:
  workflow_dispatch:

jobs:
  proxy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y dante-server curl unzip jq
          
      - name: Generate proxy credentials
        id: creds
        run: |
          USER="proxyuser"
          PASS="$(openssl rand -base64 12 | tr -d '\n' | tr '/+' 'Aa')"
          echo "user=$USER" >> "$GITHUB_OUTPUT"
          echo "pass=$PASS" >> "$GITHUB_OUTPUT"
          sudo useradd -m -s /usr/sbin/nologin "$USER" || true
          echo "$USER:$PASS" | sudo chpasswd
          
      - name: Configure SOCKS5 proxy (danted)
        run: |
          sudo tee /etc/danted.conf > /dev/null <<'EOF'
          logoutput: stderr
          internal: 127.0.0.1 port = 1080
          external: eth0
          socksmethod: username
          user.privileged: root
          user.unprivileged: nobody
          
          client pass {
            from: 0.0.0.0/0 to: 0.0.0.0/0
          }
          
          socks pass {
            from: 0.0.0.0/0 to: 0.0.0.0/0
            protocol: tcp udp
            socksmethod: username
          }
          EOF

      - name: Start SOCKS5 proxy
        run: |
          sudo systemctl restart danted
          sleep 2

      - name: Install Cloudflare Tunnel (cloudflared)
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Start Cloudflare Tunnel
        env:
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # à¦°à¦¾à¦¨à¦¾à¦° à¦¬à§à¦¯à¦¾à¦•à¦—à§à¦°à¦¾à¦‰à¦¨à§à¦¡à§‡ à¦Ÿà¦¾à¦¨à§‡à¦² à¦¸à§à¦Ÿà¦¾à¦°à§à¦Ÿ à¦•à¦°à¦¬à§‡
          cloudflared tunnel run --token $CLOUDFLARE_TUNNEL_TOKEN &
          sleep 5

      - name: Get runner public IP
        id: ip
        run: |
          IP="$(curl -s ifconfig.me || true)"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

      - name: Show Details in Actions Summary
        run: |
          {
            echo "# âœ… Cloudflare Proxy Tunnel Active"
            echo ""
            echo "| Field | Value |"
            echo "|---|---|"
            echo "| **Type** | SOCKS5 |"
            echo "| **Internal Port** | \`1080\` |"
            echo "| **Username** | \`${{ steps.creds.outputs.user }}\` |"
            echo "| **Password** | \`${{ steps.creds.outputs.pass }}\` |"
            echo "| **Exit IP** | \`${{ steps.ip.outputs.ip }}\` |"
            echo ""
            echo "## ðŸ›  How to Connect"
            echo "Since this is a Cloudflare TCP Tunnel, you must run this on your local machine to use the proxy:"
            echo "\`\`\`bash"
            echo "cloudflared access tcp --hostname YOUR_DOMAIN.com --url localhost:1080"
            echo "\`\`\`"
            echo "Then set your proxy to \`localhost:1080\` with the username/password above."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Keep runner alive (1 hour)
        run: sleep 3600
